<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µé”€æƒ…æ™¯æ¼”ç»ƒè¯„åˆ†ç³»ç»Ÿ - ä¸“ä¸šç‰ˆ</title>
    <!-- SheetJSåº“ç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDFåº“ç”¨äºPDFå¯¼å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.jsåº“ç”¨äºç”Ÿæˆé›·è¾¾å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- html2canvasç”¨äºå°†å›¾è¡¨è½¬æ¢ä¸ºå›¾ç‰‡ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #e1e8ed;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
            --shadow-hover: 0 4px 20px rgba(0,0,0,0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 40px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 13px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            background: var(--light-bg);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 20px;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .scoring-category {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .category-score {
            font-size: 20px;
            font-weight: 700;
            color: var(--success-color);
        }

        .special-rule {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 13px;
            color: #856404;
        }

        .special-rule strong {
            display: block;
            margin-bottom: 5px;
        }

        .checkpoint-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--light-bg);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .checkpoint-item:hover {
            background: #e8f4f8;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            min-width: 120px;
        }

        .checkpoint-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
        }

        .checkpoint-score {
            font-weight: 600;
            color: var(--success-color);
            font-size: 14px;
        }

        .checkpoint-text {
            flex: 1;
            padding: 0 15px;
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .deduction-input {
            width: 200px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
        }

        .file-upload-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px dashed var(--border-color);
        }

        .file-upload-area {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-btn {
            padding: 10px 20px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .file-btn:hover {
            background: #2980b9;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .file-name {
            font-size: 13px;
            color: #555;
        }

        .file-size {
            font-size: 12px;
            color: #999;
            margin-left: 10px;
        }

        .remove-file-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-file-btn:hover {
            background: #c0392b;
        }

        .result-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-top: 30px;
            display: none;
        }

        .result-section.active {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .total-score {
            font-size: 72px;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .grade {
            font-size: 32px;
            font-weight: 600;
            margin-top: 10px;
        }

        .grade-badge {
            display: inline-block;
            padding: 10px 30px;
            border-radius: 50px;
            background: rgba(255,255,255,0.2);
            margin-top: 15px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .data-table tr:hover {
            background: var(--light-bg);
        }

        .action-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .view-btn {
            background: var(--secondary-color);
            color: white;
        }

        .delete-btn {
            background: var(--danger-color);
            color: white;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .footer {
            text-align: center;
            padding: 30px;
            background: var(--light-bg);
            color: #7f8c8d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .section {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .total-score {
                font-size: 48px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .role-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-header">
            <h2>ç”µé”€æƒ…æ™¯æ¼”ç»ƒè¯„åˆ†ç³»ç»Ÿ</h2>
            <p>è¯·é€‰æ‹©è§’è‰²å¹¶ç™»å½•</p>
        </div>

        <div class="role-selector">
            <button class="role-btn active" onclick="selectRole('user')">è¯„åˆ†å‘˜</button>
            <button class="role-btn" onclick="selectRole('leader')">ç»„é•¿</button>
            <button class="role-btn" onclick="selectRole('admin')">ç®¡ç†å‘˜</button>
        </div>

        <div class="form-group">
            <label for="loginUsername">ç”¨æˆ·å</label>
            <input type="text" id="loginUsername" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <label for="loginPassword">å¯†ç </label>
            <input type="password" id="loginPassword" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>

        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="login()">ç™»å½•</button>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="header">
            <h1>ç”µé”€æƒ…æ™¯æ¼”ç»ƒè¯„åˆ†ç³»ç»Ÿ - ä¸“ä¸šç‰ˆ</h1>
            <p>è¸©ç‚¹è¯„åˆ† Â· æ™ºèƒ½è®¡ç®— Â· æ•°æ®åˆ†æ</p>
            <div class="user-info">
                <span id="currentUserInfo">ç”¨æˆ·ï¼šæœªç™»å½•</span>
                <button class="logout-btn" onclick="logout()">é€€å‡º</button>
            </div>
        </div>

        <!-- è¯„åˆ†å‘˜/ç»„é•¿ç•Œé¢ -->
        <div id="scoringPanel" class="main-content">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="section">
                <div class="section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workplace">èŒåœº</label>
                        <input type="text" id="workplace" class="form-control" placeholder="è¯·è¾“å…¥èŒåœº">
                    </div>
                    <div class="form-group">
                        <label for="team">å°ç»„</label>
                        <input type="text" id="team" class="form-control" placeholder="è¯·è¾“å…¥å°ç»„">
                    </div>
                    <div class="form-group">
                        <label for="teamLeader">ç»„é•¿</label>
                        <input type="text" id="teamLeader" class="form-control" placeholder="è¯·è¾“å…¥ç»„é•¿å§“å">
                    </div>
                    <div class="form-group">
                        <label for="evaluator">è€ƒæ ¸äºº</label>
                        <input type="text" id="evaluator" class="form-control" placeholder="è¯·è¾“å…¥è€ƒæ ¸äººå§“å">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentName">å­¦å‘˜å§“å</label>
                        <input type="text" id="studentName" class="form-control" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å">
                    </div>
                    <div class="form-group">
                        <label for="examDate">è€ƒæ ¸æ—¶é—´</label>
                        <input type="datetime-local" id="examDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="caseSelect">æƒ…æ™¯æ¡ˆä¾‹</label>
                        <select id="caseSelect" class="form-control">
                            <option value="">-- è¯·é€‰æ‹©æƒ…æ™¯æ¡ˆä¾‹ --</option>
                            <option value="case1">æ¡ˆä¾‹1 - å¹´è½»å®¶åº­ç”¨æˆ·ï¼ˆåˆ˜å…ˆç”Ÿï¼‰</option>
                            <option value="case2">æ¡ˆä¾‹2 - å•†åŠ¡ç²¾è‹±ç”¨æˆ·ï¼ˆå¼ æ€»ï¼‰</option>
                            <option value="case3">æ¡ˆä¾‹3 - å¢è´­åˆšéœ€ç”¨æˆ·ï¼ˆç‹å¥³å£«ï¼‰</option>
                            <option value="case4">æ¡ˆä¾‹4 - å¹´è½»åˆ›ä¸šè€…ï¼ˆæå…ˆç”Ÿï¼‰</option>
                            <option value="case5">æ¡ˆä¾‹5 - æ¢è´­è€ç”¨æˆ·ï¼ˆé™ˆå…ˆç”Ÿï¼‰</option>
                            <option value="case6">æ¡ˆä¾‹6 - å¯¹æ¯”ç«å“ç”¨æˆ·ï¼ˆèµµå…ˆç”Ÿï¼‰</option>
                            <option value="case7">æ¡ˆä¾‹7 - ä»·æ ¼æ•æ„Ÿç”¨æˆ·ï¼ˆå­™å¥³å£«ï¼‰</option>
                            <option value="case8">æ¡ˆä¾‹8 - ç†æ€§åˆ†æç”¨æˆ·ï¼ˆå‘¨å…ˆç”Ÿï¼‰</option>
                            <option value="case9">æ¡ˆä¾‹9 - å†²åŠ¨æ¶ˆè´¹ç”¨æˆ·ï¼ˆå´å…ˆç”Ÿï¼‰</option>
                            <option value="case10">æ¡ˆä¾‹10 - å¼‚åœ°è´­è½¦ç”¨æˆ·ï¼ˆéƒ‘å…ˆç”Ÿï¼‰</option>
                            <option value="case11">æ¡ˆä¾‹11 - æ‘‡æ‘†ä¸å®šç”¨æˆ·ï¼ˆé»„å¥³å£«ï¼‰</option>
                            <option value="case12">æ¡ˆä¾‹12 - æ”¿ç­–é©±åŠ¨ç”¨æˆ·ï¼ˆæ—å…ˆç”Ÿï¼‰</option>
                            <option value="case13">æ¡ˆä¾‹13 - ç§‘æŠ€å‘çƒ§å‹ï¼ˆä½•å…ˆç”Ÿï¼‰</option>
                            <option value="case14">æ¡ˆä¾‹14 - é•¿é€”è‡ªé©¾ç”¨æˆ·ï¼ˆæ¢å…ˆç”Ÿï¼‰</option>
                            <option value="case15">æ¡ˆä¾‹15 - å¥³æ€§ç‹¬ç«‹ç”¨æˆ·ï¼ˆå®‹å¥³å£«ï¼‰</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- è¯„åˆ†é¡¹ç›® -->
            <div class="section">
                <div class="section-title">âœ… è¯„åˆ†é¡¹ç›®ï¼ˆè¸©ç‚¹æ‰“å‹¾ï¼‰</div>
                <div id="scoringCategories"></div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼  -->
            <div class="section">
                <div class="section-title">ğŸ“ é™„ä»¶ä¸Šä¼ </div>
                <div class="file-upload-section">
                    <div class="file-upload-area">
                        <div class="file-input-wrapper">
                            <input type="file" id="audioFile" accept="audio/*" onchange="handleFileUpload('audio', this.files)">
                            <label for="audioFile" class="file-btn">ğŸ“ ä¸Šä¼ å½•éŸ³</label>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="videoFile" accept="video/*" onchange="handleFileUpload('video', this.files)">
                            <label for="videoFile" class="file-btn">ğŸ¬ ä¸Šä¼ è§†é¢‘</label>
                        </div>
                    </div>
                    <div class="file-list" id="fileList"></div>
                </div>
            </div>

            <!-- è¯„è¯­ -->
            <div class="section">
                <div class="section-title">ğŸ’¬ è¯„è¯­</div>
                <div class="form-group">
                    <label for="highlights">äº®ç‚¹</label>
                    <textarea id="highlights" class="form-control" rows="4" placeholder="è¯·è¾“å…¥å­¦å‘˜åœ¨æ¼”ç»ƒä¸­çš„äº®ç‚¹è¡¨ç°..."></textarea>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="improvements">å¾…æå‡ç‚¹</label>
                    <textarea id="improvements" class="form-control" rows="4" placeholder="è¯·è¾“å…¥å­¦å‘˜éœ€è¦æ”¹è¿›å’Œæå‡çš„æ–¹é¢..."></textarea>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateScore()">è®¡ç®—æ€»åˆ†</button>
                <button class="btn btn-success" onclick="submitRecord()">æäº¤è¯„åˆ†</button>
                <button class="btn btn-secondary" onclick="resetForm()">é‡ç½®è¡¨å•</button>
            </div>

            <!-- éšè—çš„é›·è¾¾å›¾canvasï¼Œç”¨äºç”ŸæˆPDF -->
            <div style="display: none;">
                <canvas id="radarChart" width="400" height="400"></canvas>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ç•Œé¢ -->
        <div id="adminPanel" class="admin-panel">
            <div class="main-content">
                <div class="section">
                    <div class="section-title">ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
                    <div class="admin-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalRecords">0</div>
                            <div class="stat-label">æ€»è¯„åˆ†è®°å½•</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgScore">0</div>
                            <div class="stat-label">å¹³å‡åˆ†</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="excellentRate">0%</div>
                            <div class="stat-label">ä¼˜ç§€ç‡</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ“„ æŠ¥å‘Šç”Ÿæˆ</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="generateNationalReport()">ğŸŒ ç”Ÿæˆå…¨å›½æŠ¥å‘Š</button>
                        <button class="btn btn-primary" onclick="generateWorkplaceReport()">ğŸ¢ ç”ŸæˆèŒåœºæŠ¥å‘Š</button>
                        <button class="btn btn-success" onclick="exportAllPersonalReports()">ğŸ‘¥ å¯¼å‡ºæ‰€æœ‰ä¸ªäººæŠ¥å‘Š</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ğŸ” è®°å½•æŸ¥è¯¢</div>

                    <div class="filter-section">
                        <div class="filter-item">
                            <label>èŒåœºç­›é€‰</label>
                            <input type="text" id="filterWorkplace" class="form-control" placeholder="è¾“å…¥èŒåœºåç§°">
                        </div>
                        <div class="filter-item">
                            <label>å°ç»„ç­›é€‰</label>
                            <input type="text" id="filterTeam" class="form-control" placeholder="è¾“å…¥å°ç»„åç§°">
                        </div>
                        <div class="filter-item">
                            <label>å­¦å‘˜ç­›é€‰</label>
                            <input type="text" id="filterStudent" class="form-control" placeholder="è¾“å…¥å­¦å‘˜å§“å">
                        </div>
                        <div class="filter-item">
                            <button class="btn btn-primary" style="margin-top: 24px;" onclick="filterRecords()">ç­›é€‰</button>
                            <button class="btn btn-secondary" style="margin-top: 24px;" onclick="clearFilters()">æ¸…é™¤</button>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
                        <button class="btn btn-warning" onclick="exportFiltered()">ğŸ“¥ å¯¼å‡ºç­›é€‰ç»“æœ</button>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>èŒåœº</th>
                                <th>å°ç»„</th>
                                <th>å­¦å‘˜</th>
                                <th>ç»„é•¿</th>
                                <th>è€ƒæ ¸äºº</th>
                                <th>æ¡ˆä¾‹</th>
                                <th>æ€»åˆ†</th>
                                <th>è¯„çº§</th>
                                <th>æäº¤æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ç”µé”€æƒ…æ™¯æ¼”ç»ƒè¯„åˆ†ç³»ç»Ÿ ä¸“ä¸šç‰ˆ v2.0 | æ”¯æŒå¤šäººåä½œä¸æ•°æ®åˆ†æ</p>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                è¯„åˆ†è¯¦æƒ…
                <button class="btn btn-secondary" style="float: right; padding: 5px 15px;" onclick="closeModal()">å…³é—­</button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentRole = 'user';
        let uploadedFiles = { audio: null, video: null };
        let filteredRecords = null;

        // è¯„åˆ†æ ‡å‡†æ•°æ®ï¼ˆæ ¹æ®è¯„åˆ†è¡¨PDFï¼‰
        const scoringCriteria = {
            opening: {
                name: 'å¼€åœºç™½',
                maxScore: 15,
                specialRule: 'æ¯ä¸ªè¸©ç‚¹å¿…é¡»ç¬¦åˆæ‰å¾—åˆ†',
                checkpoints: [
                    { id: 'opening_1', text: 'è¯­éŸ³æ¸…æ™°ã€è¯­è°ƒä¸Šæ‰¬ã€è¯­é€Ÿé€‚ä¸­ã€æ€åº¦è€å¿ƒï¼Œæ— æ€¥èºæ•·è¡æƒ…ç»ª', score: 5 },
                    { id: 'opening_2', text: 'ç¤¼è²Œé—®å€™ï¼Œå¼•å¯¼ç”¨æˆ·èšç„¦å¯¹è¯', score: 5 },
                    { id: 'opening_3', text: 'å¿«é€Ÿè‡ªæŠ¥å…¬å¸ã€èº«ä»½ã€å§“ååŠæ¥ç”µç›®çš„', score: 5 }
                ]
            },
            needsAnalysis: {
                name: 'éœ€æ±‚åˆ†æ',
                maxScore: 15,
                specialRule: 'ç¬¦åˆ2æ¡å³å¾—15åˆ†ï¼Œå¦åˆ™æ¯æ¡å¾—5åˆ†',
                checkpoints: [
                    { id: 'needs_1', text: 'ä¸»åŠ¨è¯¢é—®ç”¨æˆ·è´­è½¦ç”¨é€”ï¼ˆå®¶ç”¨/å•†ç”¨/ä»£æ­¥ç­‰ï¼‰/æ–¹æ¡ˆï¼ˆæ–°è´­/ç½®æ¢/æ·»ç½®ç­‰ï¼‰/æ—¶é—´ï¼ˆ3å¤©/7å¤©/14å¤©/1ä¸ªæœˆå†…ç­‰ï¼‰', score: 5 },
                    { id: 'needs_2', text: 'äº†è§£ç”¨æˆ·æœ‰æ— å¯¹æ¯”ç«å“ï¼ˆå“ç‰Œã€è½¦å‹ç­‰ï¼‰', score: 5 },
                    { id: 'needs_3', text: 'äº†è§£ç”¨æˆ·å¯¹è½¦è¾†æ ¸å¿ƒå…³æ³¨ç‚¹/ç—›ç‚¹ï¼ˆç©ºé—´/åŠ¨åŠ›/æ²¹è€—/é…ç½®ç­‰ï¼‰', score: 5 }
                ]
            },
            carSelection: {
                name: 'è½¦å‹åˆ¤å®š',
                maxScore: 10,
                specialRule: 'æ¯ä¸ªè¸©ç‚¹å¿…é¡»ç¬¦åˆæ‰å¾—åˆ†',
                checkpoints: [
                    { id: 'car_1', text: 'åŸºäºç”¨æˆ·éœ€æ±‚ï¼Œç²¾å‡†åŒ¹é…1-2æ¬¾ç›®æ ‡è½¦å‹', score: 5 },
                    { id: 'car_2', text: 'è¯´æ˜åˆ¤å®šç†ç”±ï¼Œä¸ç”¨æˆ·éœ€æ±‚å¼ºå…³è”', score: 5 }
                ]
            },
            productIntro: {
                name: 'äº§å“ä»‹ç»',
                maxScore: 15,
                specialRule: 'ç¬¦åˆ2æ¡å³å¾—15åˆ†ï¼Œå¦åˆ™æ¯æ¡å¾—5åˆ†',
                checkpoints: [
                    { id: 'product_1', text: 'èšç„¦ç›®æ ‡è½¦å‹æ ¸å¿ƒä¼˜åŠ¿ï¼Œè´´åˆç”¨æˆ·éœ€æ±‚', score: 5 },
                    { id: 'product_2', text: 'å¯¹æ¯”ç«å“ä¼˜åŠ¿ï¼ˆå¦‚æœ‰ï¼‰ï¼Œéœ€çªå‡ºå·®å¼‚åŒ–', score: 5 },
                    { id: 'product_3', text: 'ä¼ é€’ä¿¡æ¯çœŸå®å‡†ç¡®ï¼Œè¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œç”¨æˆ·æ˜“ç†è§£', score: 5 }
                ]
            },
            objectionHandling: {
                name: 'å¼‚è®®å¤„ç†',
                maxScore: 15,
                specialRule: 'ç¬¦åˆ2æ¡å³å¾—15åˆ†ï¼Œå¦åˆ™æ¯æ¡å¾—5åˆ†',
                checkpoints: [
                    { id: 'objection_1', text: 'åŠæ—¶æ•æ‰ç”¨æˆ·å¼‚è®®ï¼ˆä»·æ ¼/é…ç½®/å£ç¢‘ç­‰ï¼‰', score: 5 },
                    { id: 'objection_2', text: 'å¼‚è®®é—®é¢˜é’ˆå¯¹æ€§ç»™å‡ºåˆç†è§£é‡Šï¼Œé€»è¾‘æ¸…æ™°', score: 5 },
                    { id: 'objection_3', text: 'æ€åº¦å¹³å’Œçš„å¼•å¯¼ç”¨æˆ·è½¬å˜è®¤çŸ¥ï¼ŒåŒ–è§£é¡¾è™‘ï¼Œä¸ä¸å®¢æˆ·äº‰è¾©', score: 5 }
                ]
            },
            testDriveAware: {
                name: 'è®¤çŸ¥è¯•é©¾',
                maxScore: 5,
                specialRule: 'ç¬¦åˆå³å¾—åˆ†',
                checkpoints: [
                    { id: 'testdrive_aware', text: 'ä¸»åŠ¨å‘ç”¨æˆ·ä¼ é€’è¯•é©¾ä»·å€¼ï¼ˆä½“éªŒæ€§èƒ½/æ„Ÿå—èˆ’é€‚åº¦ç­‰ï¼‰ï¼Œå¹¶å¼ºè°ƒè¯•é©¾å¯¹è´­è½¦å†³ç­–çš„é‡è¦æ€§', score: 5 }
                ]
            },
            testDrivePackage: {
                name: 'åŒ…è£…è¯•é©¾',
                maxScore: 5,
                specialRule: '3ä¸ªè¯•é©¾ç»´åº¦ç¬¦åˆ3æ¡å³å¾—15åˆ†ï¼Œå¦åˆ™æ¯æ¡å¾—5åˆ†',
                checkpoints: [
                    { id: 'testdrive_package', text: 'ä»‹ç»è¯•é©¾æœåŠ¡ç»†èŠ‚ï¼ˆæ—¶é—´/è·¯çº¿/é™ªåŒäººå‘˜ç­‰ï¼‰ï¼Œçªå‡ºè¯•é©¾è¿‡ç¨‹çš„ä¸“ä¸šæ€§å’Œä¾¿åˆ©æ€§', score: 5 }
                ]
            },
            testDriveInvite: {
                name: 'é‚€çº¦è¯•é©¾',
                maxScore: 5,
                specialRule: '3ä¸ªè¯•é©¾ç»´åº¦ç¬¦åˆ3æ¡å³å¾—15åˆ†ï¼Œå¦åˆ™æ¯æ¡å¾—5åˆ†',
                checkpoints: [
                    { id: 'testdrive_invite', text: 'ç§¯æä¸»åŠ¨æå‡ºè¯•é©¾é‚€çº¦ï¼Œå¹¶çµæ´»åå•†è¯•é©¾æ—¶é—´ï¼Œé€‚é…ç”¨æˆ·æ—¥ç¨‹', score: 5 }
                ]
            },
            testDriveConfirm: {
                name: 'æ˜ç¡®è¯•é©¾',
                maxScore: 5,
                specialRule: '3ä¸ªè¯•é©¾ç»´åº¦ç¬¦åˆ3æ¡å³å¾—15åˆ†ï¼Œå¦åˆ™æ¯æ¡å¾—5åˆ†',
                checkpoints: [
                    { id: 'testdrive_confirm', text: 'æ¸…æ™°å‘ŠçŸ¥è¯•é©¾æ—¶é—´/åœ°ç‚¹ã€éœ€æºå¸¦è¯ä»¶ç­‰ä¿¡æ¯ï¼Œé¿å…åå·®', score: 5 }
                ]
            },
            closing: {
                name: 'ç»“æŸè¯­',
                maxScore: 10,
                specialRule: 'æ¯ä¸ªè¸©ç‚¹å¿…é¡»ç¬¦åˆæ‰å¾—åˆ†',
                checkpoints: [
                    { id: 'closing_1', text: 'ä¸»åŠ¨æåŠæ·»åŠ ä¼ä¸šå¾®ä¿¡ï¼Œå¹¶æ³¨æ„æ¥å¬é—¨åº—å¯¹æ¥ç”µè¯', score: 5 },
                    { id: 'closing_2', text: 'ç¤¼è²Œé“åˆ«ï¼Œæ„Ÿè°¢ç”¨æˆ·æ—¶é—´ï¼Œæç¤ºæœ‰é—®é¢˜éšæ—¶æ²Ÿé€š', score: 5 }
                ]
            }
        };

        // åˆå§‹åŒ–IndexedDB
        let db;
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ScoringSystemDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('records')) {
                        db.createObjectStore('records', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await initDB();
            initScoringCategories();
            setDefaultDateTime();
        });

        // è§’è‰²é€‰æ‹©
        function selectRole(role) {
            currentRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ç™»å½•
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            // ç®€å•çš„éªŒè¯é€»è¾‘ï¼ˆå®é™…åº”è¯¥å¯¹æ¥åç«¯ï¼‰
            const users = {
                'user': { password: '123456', role: 'user', name: 'è¯„åˆ†å‘˜' },
                'leader': { password: '123456', role: 'leader', name: 'ç»„é•¿' },
                'admin': { password: 'admin123', role: 'admin', name: 'ç®¡ç†å‘˜' }
            };

            if (users[username] && users[username].password === password && users[username].role === currentRole) {
                currentUser = {
                    username: username,
                    role: currentRole,
                    name: users[username].name
                };

                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('currentUserInfo').textContent = `${currentUser.name}ï¼š${username}`;

                if (currentRole === 'admin' || currentRole === 'leader') {
                    // ç®¡ç†å‘˜å’Œç»„é•¿éƒ½è¿›å…¥åå°
                    document.getElementById('scoringPanel').style.display = 'none';
                    document.getElementById('adminPanel').classList.add('active');
                    loadAdminData();
                } else {
                    // æ™®é€šè¯„åˆ†å‘˜è¿›å…¥è¯„åˆ†ç•Œé¢
                    document.getElementById('scoringPanel').style.display = 'block';
                    document.getElementById('adminPanel').classList.remove('active');
                }
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');
            }
        }

        // é€€å‡º
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                currentUser = null;
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
                resetForm();
            }
        }

        // è®¾ç½®é»˜è®¤æ—¥æœŸæ—¶é—´
        function setDefaultDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const datetimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('examDate').value = datetimeLocal;
        }

        // åˆå§‹åŒ–è¯„åˆ†åˆ†ç±»
        function initScoringCategories() {
            const container = document.getElementById('scoringCategories');
            container.innerHTML = '';

            Object.keys(scoringCriteria).forEach(categoryKey => {
                const category = scoringCriteria[categoryKey];

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'scoring-category';
                categoryDiv.id = `category-${categoryKey}`;

                let html = `
                    <div class="category-header">
                        <span class="category-title">${category.name}</span>
                        <span class="category-score" id="score-${categoryKey}">0 / ${category.maxScore}åˆ†</span>
                    </div>
                    <div class="special-rule">
                        <strong>âš ï¸ ç‰¹æ®Šè¯´æ˜ï¼š</strong>${category.specialRule}
                    </div>
                `;

                category.checkpoints.forEach(checkpoint => {
                    html += `
                        <div class="checkpoint-item">
                            <div class="checkbox-wrapper">
                                <input type="checkbox"
                                       class="checkpoint-checkbox"
                                       id="${checkpoint.id}"
                                       data-category="${categoryKey}"
                                       data-score="${checkpoint.score}"
                                       onchange="updateCategoryScore('${categoryKey}')">
                                <span class="checkpoint-score">${checkpoint.score}åˆ†</span>
                            </div>
                            <div class="checkpoint-text">${checkpoint.text}</div>
                            <input type="text"
                                   class="deduction-input"
                                   id="deduction-${checkpoint.id}"
                                   placeholder="æ‰£åˆ†è¯´æ˜ï¼ˆé€‰å¡«ï¼‰">
                        </div>
                    `;
                });

                categoryDiv.innerHTML = html;
                container.appendChild(categoryDiv);
            });
        }

        // æ›´æ–°åˆ†ç±»å¾—åˆ†
        function updateCategoryScore(categoryKey) {
            const category = scoringCriteria[categoryKey];
            const checkboxes = document.querySelectorAll(`input[data-category="${categoryKey}"]:checked`);
            const checkedCount = checkboxes.length;
            const totalCheckpoints = category.checkpoints.length;

            let score = 0;

            // æ ¹æ®ç‰¹æ®Šè§„åˆ™è®¡ç®—åˆ†æ•°
            if (category.specialRule.includes('ç¬¦åˆ2æ¡å³å¾—15åˆ†')) {
                // éœ€æ±‚åˆ†æã€äº§å“ä»‹ç»ã€å¼‚è®®å¤„ç†
                if (checkedCount >= 2) {
                    score = 15;
                } else {
                    score = checkedCount * 5;
                }
            } else if (category.specialRule.includes('3ä¸ªè¯•é©¾ç»´åº¦ç¬¦åˆ3æ¡å³å¾—15åˆ†')) {
                // è¯•é©¾ç¯èŠ‚éœ€è¦ç»Ÿä¸€è®¡ç®—
                const testDriveChecked =
                    document.querySelectorAll('input[data-category="testDrivePackage"]:checked').length +
                    document.querySelectorAll('input[data-category="testDriveInvite"]:checked').length +
                    document.querySelectorAll('input[data-category="testDriveConfirm"]:checked').length;

                if (testDriveChecked >= 3) {
                    score = 5; // æ¯ä¸ªè¯•é©¾ç»´åº¦å„5åˆ†ï¼Œå…±15åˆ†
                } else {
                    score = checkedCount * 5;
                }
            } else {
                // å¼€åœºç™½ã€è½¦å‹åˆ¤å®šã€ç»“æŸè¯­ã€è®¤çŸ¥è¯•é©¾
                score = checkedCount * 5;
            }

            document.getElementById(`score-${categoryKey}`).textContent = `${score} / ${category.maxScore}åˆ†`;

            updateProgress();
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            let totalScore = 0;
            Object.keys(scoringCriteria).forEach(key => {
                const scoreText = document.getElementById(`score-${key}`).textContent;
                const score = parseInt(scoreText.split('/')[0].trim());
                totalScore += score;
            });

            const percentage = (totalScore / 100) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // è®¡ç®—æ€»åˆ†
        function calculateScore() {
            // éªŒè¯åŸºæœ¬ä¿¡æ¯
            const requiredFields = ['workplace', 'team', 'teamLeader', 'evaluator', 'studentName', 'examDate', 'caseSelect'];
            for (let field of requiredFields) {
                const value = document.getElementById(field).value.trim();
                if (!value) {
                    alert('è¯·å®Œæ•´å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼');
                    document.getElementById(field).focus();
                    return;
                }
            }

            let totalScore = 0;
            const scoreDetails = {};

            Object.keys(scoringCriteria).forEach(key => {
                const scoreText = document.getElementById(`score-${key}`).textContent;
                const score = parseInt(scoreText.split('/')[0].trim());
                totalScore += score;
                scoreDetails[scoringCriteria[key].name] = score;
            });

            displayResult(totalScore, scoreDetails);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(totalScore, scoreDetails) {
            const resultSection = document.getElementById('resultSection');
            const totalScoreElement = document.getElementById('totalScore');
            const gradeBadge = document.getElementById('gradeBadge');

            // è®¡ç®—ç­‰çº§
            let grade, gradeColor, gradeEmoji;
            if (totalScore >= 90) {
                grade = 'ä¼˜ç§€';
                gradeColor = 'var(--success-color)';
                gradeEmoji = 'ğŸ‰';
            } else if (totalScore >= 80) {
                grade = 'è‰¯å¥½';
                gradeColor = 'var(--secondary-color)';
                gradeEmoji = 'ğŸ‘';
            } else {
                grade = 'ä¸åˆæ ¼';
                gradeColor = 'var(--danger-color)';
                gradeEmoji = 'âš ï¸';
            }

            totalScoreElement.textContent = totalScore.toFixed(1);
            gradeBadge.textContent = `${gradeEmoji} ${grade}`;
            gradeBadge.style.background = gradeColor;

            resultSection.classList.add('active');
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        async function handleFileUpload(type, files) {
            if (files.length === 0) return;

            const file = files[0];
            const maxSize = type === 'audio' ? 50 * 1024 * 1024 : 100 * 1024 * 1024; // 50MB for audio, 100MB for video

            if (file.size > maxSize) {
                alert(`æ–‡ä»¶å¤ªå¤§ï¼${type === 'audio' ? 'å½•éŸ³' : 'è§†é¢‘'}æ–‡ä»¶æœ€å¤§${type === 'audio' ? '50MB' : '100MB'}`);
                return;
            }

            // è¯»å–æ–‡ä»¶ä¸ºbase64ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
            const reader = new FileReader();
            reader.onload = async (e) => {
                uploadedFiles[type] = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: e.target.result
                };

                // å­˜å‚¨åˆ°IndexedDB
                const transaction = db.transaction(['files'], 'readwrite');
                const store = transaction.objectStore('files');
                await store.put({
                    id: `${type}_${Date.now()}`,
                    ...uploadedFiles[type]
                });

                updateFileList();
            };
            reader.readAsDataURL(file);
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            ['audio', 'video'].forEach(type => {
                if (uploadedFiles[type]) {
                    const file = uploadedFiles[type];
                    const sizeText = (file.size / 1024 / 1024).toFixed(2) + ' MB';

                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div>
                            <span class="file-name">${type === 'audio' ? 'ğŸµ' : 'ğŸ¬'} ${file.name}</span>
                            <span class="file-size">${sizeText}</span>
                        </div>
                        <button class="remove-file-btn" onclick="removeFile('${type}')">åˆ é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                }
            });
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(type) {
            uploadedFiles[type] = null;
            document.getElementById(type + 'File').value = '';
            updateFileList();
        }

        // æäº¤è®°å½•
        async function submitRecord() {
            // å…ˆè®¡ç®—æ€»åˆ†
            calculateScore();

            const record = {
                workplace: document.getElementById('workplace').value.trim(),
                team: document.getElementById('team').value.trim(),
                teamLeader: document.getElementById('teamLeader').value.trim(),
                evaluator: document.getElementById('evaluator').value.trim(),
                studentName: document.getElementById('studentName').value.trim(),
                examDate: document.getElementById('examDate').value,
                case: document.getElementById('caseSelect').value,
                scores: {},
                deductions: {},
                highlights: document.getElementById('highlights').value.trim(),
                improvements: document.getElementById('improvements').value.trim(),
                totalScore: 0,
                grade: '',
                files: { ...uploadedFiles },
                submitter: currentUser.username,
                submitTime: new Date().toISOString()
            };

            // æ”¶é›†æ‰€æœ‰è¯„åˆ†
            Object.keys(scoringCriteria).forEach(key => {
                const scoreText = document.getElementById(`score-${key}`).textContent;
                const score = parseInt(scoreText.split('/')[0].trim());
                record.scores[scoringCriteria[key].name] = score;
                record.totalScore += score;

                // æ”¶é›†æ‰£åˆ†è¯´æ˜
                scoringCriteria[key].checkpoints.forEach(checkpoint => {
                    const deduction = document.getElementById(`deduction-${checkpoint.id}`).value.trim();
                    if (deduction) {
                        record.deductions[checkpoint.text] = deduction;
                    }
                });
            });

            // è®¡ç®—è¯„çº§
            if (record.totalScore >= 90) record.grade = 'ä¼˜ç§€';
            else if (record.totalScore >= 80) record.grade = 'è‰¯å¥½';
            else record.grade = 'ä¸åˆæ ¼';

            // ä¿å­˜åˆ°IndexedDB
            const transaction = db.transaction(['records'], 'readwrite');
            const store = transaction.objectStore('records');
            await store.add(record);

            alert('âœ… è¯„åˆ†å·²æˆåŠŸæäº¤ï¼');

            if (confirm('æ˜¯å¦é‡ç½®è¡¨å•ç»§ç»­è¯„åˆ†ï¼Ÿ')) {
                resetForm();
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            if (confirm('ç¡®å®šè¦é‡ç½®è¡¨å•å—ï¼Ÿæ‰€æœ‰æœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ï¼')) {
                // é‡ç½®åŸºæœ¬ä¿¡æ¯
                ['workplace', 'team', 'teamLeader', 'evaluator', 'studentName', 'caseSelect'].forEach(id => {
                    document.getElementById(id).value = '';
                });

                // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†
                document.querySelectorAll('.checkpoint-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // é‡ç½®æ‰€æœ‰æ‰£åˆ†è¯´æ˜
                document.querySelectorAll('.deduction-input').forEach(input => {
                    input.value = '';
                });

                // é‡ç½®è¯„è¯­
                document.getElementById('highlights').value = '';
                document.getElementById('improvements').value = '';

                // é‡ç½®æ–‡ä»¶
                uploadedFiles = { audio: null, video: null };
                updateFileList();

                // é‡ç½®åˆ†æ•°æ˜¾ç¤º
                Object.keys(scoringCriteria).forEach(key => {
                    updateCategoryScore(key);
                });

                // éšè—ç»“æœ
                document.getElementById('resultSection').classList.remove('active');

                setDefaultDateTime();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // åŠ è½½ç®¡ç†å‘˜æ•°æ®
        async function loadAdminData() {
            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();

            request.onsuccess = () => {
                let records = request.result;

                // ç»„é•¿æƒé™æ§åˆ¶ï¼šåªèƒ½çœ‹æœ¬ç»„çš„æ•°æ®
                if (currentUser.role === 'leader') {
                    // è·å–ç»„é•¿å§“åï¼ˆå‡è®¾ç»„é•¿ç”¨æˆ·åå°±æ˜¯å§“åï¼‰
                    const leaderName = currentUser.username;
                    records = records.filter(r => r.teamLeader === leaderName || r.team.includes(leaderName));
                }

                // ç»Ÿè®¡æ•°æ®
                document.getElementById('totalRecords').textContent = records.length;

                if (records.length > 0) {
                    const avgScore = (records.reduce((sum, r) => sum + r.totalScore, 0) / records.length).toFixed(1);
                    document.getElementById('avgScore').textContent = avgScore;

                    const excellentCount = records.filter(r => r.totalScore >= 90).length;
                    const excellentRate = ((excellentCount / records.length) * 100).toFixed(1);
                    document.getElementById('excellentRate').textContent = excellentRate + '%';
                }

                displayRecords(records);
            };
        }

        // æ˜¾ç¤ºè®°å½•
        function displayRecords(records) {
            const tbody = document.getElementById('recordsTable');
            tbody.innerHTML = '';

            records.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${record.workplace}</td>
                    <td>${record.team}</td>
                    <td>${record.studentName}</td>
                    <td>${record.teamLeader}</td>
                    <td>${record.evaluator}</td>
                    <td>${record.case}</td>
                    <td><strong>${record.totalScore}</strong></td>
                    <td>${record.grade}</td>
                    <td>${new Date(record.submitTime).toLocaleString('zh-CN')}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewDetail(${record.id})">æŸ¥çœ‹</button>
                        <button class="action-btn view-btn" onclick="generatePersonalReport(${record.id})">æŠ¥å‘Š</button>
                        <button class="action-btn delete-btn" onclick="deleteRecord(${record.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æŸ¥çœ‹è¯¦æƒ…
        async function viewDetail(id) {
            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.get(id);

            request.onsuccess = () => {
                const record = request.result;
                let html = `
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <p><strong>èŒåœºï¼š</strong>${record.workplace}</p>
                    <p><strong>å°ç»„ï¼š</strong>${record.team}</p>
                    <p><strong>å­¦å‘˜ï¼š</strong>${record.studentName}</p>
                    <p><strong>ç»„é•¿ï¼š</strong>${record.teamLeader}</p>
                    <p><strong>è€ƒæ ¸äººï¼š</strong>${record.evaluator}</p>
                    <p><strong>è€ƒæ ¸æ—¶é—´ï¼š</strong>${new Date(record.examDate).toLocaleString('zh-CN')}</p>

                    <h3>è¯„åˆ†è¯¦æƒ…</h3>
                    <p><strong>æ€»åˆ†ï¼š</strong>${record.totalScore} / 100</p>
                    <p><strong>è¯„çº§ï¼š</strong>${record.grade}</p>

                    <h4>å„é¡¹å¾—åˆ†ï¼š</h4>
                    <ul>
                        ${Object.entries(record.scores).map(([name, score]) => `<li>${name}: ${score}åˆ†</li>`).join('')}
                    </ul>

                    ${Object.keys(record.deductions).length > 0 ? `
                        <h4>æ‰£åˆ†è¯´æ˜ï¼š</h4>
                        <ul>
                            ${Object.entries(record.deductions).map(([item, reason]) => `<li>${item}: ${reason}</li>`).join('')}
                        </ul>
                    ` : ''}

                    ${record.files.audio || record.files.video ? `
                        <h4>é™„ä»¶ï¼š</h4>
                        <ul>
                            ${record.files.audio ? `<li>ğŸµ ${record.files.audio.name}</li>` : ''}
                            ${record.files.video ? `<li>ğŸ¬ ${record.files.video.name}</li>` : ''}
                        </ul>
                    ` : ''}
                `;

                document.getElementById('detailContent').innerHTML = html;
                document.getElementById('detailModal').classList.add('active');
            };
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                const transaction = db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                await store.delete(id);

                alert('è®°å½•å·²åˆ é™¤');
                loadAdminData();
            }
        }

        // ç­›é€‰è®°å½•
        async function filterRecords() {
            const workplace = document.getElementById('filterWorkplace').value.trim().toLowerCase();
            const team = document.getElementById('filterTeam').value.trim().toLowerCase();
            const student = document.getElementById('filterStudent').value.trim().toLowerCase();

            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();

            request.onsuccess = () => {
                let records = request.result;

                if (workplace) {
                    records = records.filter(r => r.workplace.toLowerCase().includes(workplace));
                }
                if (team) {
                    records = records.filter(r => r.team.toLowerCase().includes(team));
                }
                if (student) {
                    records = records.filter(r => r.studentName.toLowerCase().includes(student));
                }

                filteredRecords = records;
                displayRecords(records);
            };
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('filterWorkplace').value = '';
            document.getElementById('filterTeam').value = '';
            document.getElementById('filterStudent').value = '';
            filteredRecords = null;
            loadAdminData();
        }

        // å¯¼å‡ºExcel
        async function exportToExcel() {
            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();

            request.onsuccess = () => {
                const records = request.result;
                generateExcel(records, 'å…¨éƒ¨è¯„åˆ†è®°å½•');
            };
        }

        // å¯¼å‡ºç­›é€‰ç»“æœ
        function exportFiltered() {
            if (!filteredRecords || filteredRecords.length === 0) {
                alert('è¯·å…ˆè¿›è¡Œç­›é€‰ï¼');
                return;
            }
            generateExcel(filteredRecords, 'ç­›é€‰è¯„åˆ†è®°å½•');
        }

        // ç”ŸæˆExcel
        function generateExcel(records, filename) {
            if (records.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }

            // å‡†å¤‡æ•°æ®
            const data = records.map((record, index) => ({
                'åºå·': index + 1,
                'èŒåœº': record.workplace,
                'å°ç»„': record.team,
                'å­¦å‘˜å§“å': record.studentName,
                'ç»„é•¿': record.teamLeader,
                'è€ƒæ ¸äºº': record.evaluator,
                'æ¡ˆä¾‹': record.case,
                'å¼€åœºç™½': record.scores['å¼€åœºç™½'] || 0,
                'éœ€æ±‚åˆ†æ': record.scores['éœ€æ±‚åˆ†æ'] || 0,
                'è½¦å‹åˆ¤å®š': record.scores['è½¦å‹åˆ¤å®š'] || 0,
                'äº§å“ä»‹ç»': record.scores['äº§å“ä»‹ç»'] || 0,
                'å¼‚è®®å¤„ç†': record.scores['å¼‚è®®å¤„ç†'] || 0,
                'è®¤çŸ¥è¯•é©¾': record.scores['è®¤çŸ¥è¯•é©¾'] || 0,
                'åŒ…è£…è¯•é©¾': record.scores['åŒ…è£…è¯•é©¾'] || 0,
                'é‚€çº¦è¯•é©¾': record.scores['é‚€çº¦è¯•é©¾'] || 0,
                'æ˜ç¡®è¯•é©¾': record.scores['æ˜ç¡®è¯•é©¾'] || 0,
                'ç»“æŸè¯­': record.scores['ç»“æŸè¯­'] || 0,
                'æ€»åˆ†': record.totalScore,
                'è¯„çº§': record.grade,
                'è€ƒæ ¸æ—¶é—´': new Date(record.examDate).toLocaleString('zh-CN'),
                'æäº¤æ—¶é—´': new Date(record.submitTime).toLocaleString('zh-CN')
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è¯„åˆ†è®°å½•');

            // ä¸‹è½½
            XLSX.writeFile(wb, `${filename}_${new Date().toLocaleDateString('zh-CN')}.xlsx`);
        }

        // ç”Ÿæˆä¸ªäººæŠ¥å‘Šï¼ˆä»ç®¡ç†åå°è°ƒç”¨ï¼‰
        async function generatePersonalReport(recordId) {
            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.get(recordId);

            request.onsuccess = async () => {
                const record = request.result;
                await createPersonalPDFReport(record);
            };
        }

        // åˆ›å»ºä¸ªäººPDFæŠ¥å‘Šçš„æ ¸å¿ƒå‡½æ•°
        async function createPersonalPDFReport(record) {
            const { jsPDF } = window.jspdf;

            // ç”Ÿæˆé›·è¾¾å›¾
            const radarCanvas = document.getElementById('radarChart');
            const ctx = radarCanvas.getContext('2d');

            if (window.radarChartInstance) {
                window.radarChartInstance.destroy();
            }

            const scoreData = {};
            Object.keys(scoringCriteria).forEach(key => {
                const category = scoringCriteria[key];
                scoreData[category.name] = {
                    score: record.scores[category.name] || 0,
                    maxScore: category.maxScore
                };
            });

            window.radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(scoreData),
                    datasets: [{
                        label: 'å¾—åˆ†',
                        data: Object.values(scoreData).map(item => (item.score / item.maxScore) * 100),
                        fill: true,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgb(52, 152, 219)',
                        pointBackgroundColor: 'rgb(52, 152, 219)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(52, 152, 219)'
                    }]
                },
                options: {
                    elements: { line: { borderWidth: 3 } },
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: { stepSize: 20 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            await new Promise(resolve => setTimeout(resolve, 500));
            const radarImage = radarCanvas.toDataURL('image/png');

            // åˆ›å»ºPDF
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let yPos = 20;

            pdf.setFont('helvetica');

            // æ ‡é¢˜
            pdf.setFontSize(20);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Sales Training Performance Report', pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;

            // åŸºæœ¬ä¿¡æ¯
            pdf.setFontSize(12);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Student: ${record.studentName}`, 20, yPos);
            yPos += 7;
            pdf.text(`Workplace: ${record.workplace}`, 20, yPos);
            yPos += 7;
            pdf.text(`Team: ${record.team}`, 20, yPos);
            yPos += 7;
            pdf.text(`Team Leader: ${record.teamLeader}`, 20, yPos);
            yPos += 7;
            pdf.text(`Evaluator: ${record.evaluator}`, 20, yPos);
            yPos += 7;
            pdf.text(`Date: ${new Date(record.examDate).toLocaleString('zh-CN')}`, 20, yPos);
            yPos += 12;

            // æ€»åˆ†å’Œè¯„çº§
            pdf.setFontSize(16);
            pdf.setTextColor(52, 152, 219);
            pdf.text(`Total Score: ${record.totalScore} / 100`, 20, yPos);
            yPos += 10;
            pdf.setFontSize(14);

            if (record.grade === 'ä¼˜ç§€') pdf.setTextColor(39, 174, 96);
            else if (record.grade === 'è‰¯å¥½') pdf.setTextColor(52, 152, 219);
            else pdf.setTextColor(231, 76, 60);

            pdf.text(`Grade: ${record.grade}`, 20, yPos);
            yPos += 15;

            // è¯¦ç»†å¾—åˆ†
            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Detailed Scores:', 20, yPos);
            yPos += 8;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            Object.entries(scoreData).forEach(([name, data]) => {
                const percent = ((data.score / data.maxScore) * 100).toFixed(0);
                pdf.text(`${name}: ${data.score}/${data.maxScore} (${percent}%)`, 25, yPos);
                yPos += 6;
                if (yPos > pageHeight - 20) {
                    pdf.addPage();
                    yPos = 20;
                }
            });
            yPos += 5;

            // å¤±åˆ†ç‚¹
            const lostPoints = {};
            Object.entries(scoreData).forEach(([name, data]) => {
                const lost = data.maxScore - data.score;
                if (lost > 0) lostPoints[name] = lost;
            });

            if (Object.keys(lostPoints).length > 0) {
                if (yPos > pageHeight - 40) {
                    pdf.addPage();
                    yPos = 20;
                }

                pdf.setFontSize(14);
                pdf.setTextColor(231, 76, 60);
                pdf.text('Lost Points:', 20, yPos);
                yPos += 8;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                Object.entries(lostPoints).forEach(([name, points]) => {
                    pdf.text(`${name}: -${points} points`, 25, yPos);
                    yPos += 6;
                });
                yPos += 5;
            }

            // è¯„è¯­
            if (record.highlights || record.improvements) {
                if (yPos > pageHeight - 60) {
                    pdf.addPage();
                    yPos = 20;
                }

                pdf.setFontSize(14);
                pdf.setTextColor(44, 62, 80);
                pdf.text('Comments:', 20, yPos);
                yPos += 10;

                if (record.highlights) {
                    pdf.setFontSize(12);
                    pdf.setTextColor(39, 174, 96);
                    pdf.text('Highlights:', 25, yPos);
                    yPos += 6;

                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    const highlightLines = pdf.splitTextToSize(record.highlights, pageWidth - 50);
                    highlightLines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            pdf.addPage();
                            yPos = 20;
                        }
                        pdf.text(line, 30, yPos);
                        yPos += 5;
                    });
                    yPos += 5;
                }

                if (record.improvements) {
                    if (yPos > pageHeight - 30) {
                        pdf.addPage();
                        yPos = 20;
                    }

                    pdf.setFontSize(12);
                    pdf.setTextColor(243, 156, 18);
                    pdf.text('Areas for Improvement:', 25, yPos);
                    yPos += 6;

                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    const improvementLines = pdf.splitTextToSize(record.improvements, pageWidth - 50);
                    improvementLines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            pdf.addPage();
                            yPos = 20;
                        }
                        pdf.text(line, 30, yPos);
                        yPos += 5;
                    });
                    yPos += 10;
                }
            }

            // é›·è¾¾å›¾
            pdf.addPage();
            yPos = 20;

            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Performance Radar Chart:', pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;

            const imgWidth = 150;
            const imgHeight = 150;
            const xPos = (pageWidth - imgWidth) / 2;
            pdf.addImage(radarImage, 'PNG', xPos, yPos, imgWidth, imgHeight);
            yPos += imgHeight + 15;

            // å‘å±•å»ºè®®
            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('Development Suggestions:', 20, yPos);
            yPos += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);

            let suggestions = [];
            if (record.totalScore >= 90) {
                suggestions = [
                    '1. Excellent performance! Continue to maintain and optimize current strengths.',
                    '2. Share best practices with team members to drive overall improvement.',
                    '3. Focus on advanced skills and industry cutting-edge knowledge.'
                ];
            } else if (record.totalScore >= 80) {
                suggestions = [
                    '1. Good foundation, focus on improving weak areas.',
                    '2. Strengthen practice in key scenarios to improve proficiency.',
                    '3. Learn from excellent cases and optimize communication skills.'
                ];
            } else {
                suggestions = [
                    '1. Need systematic training to master basic sales skills.',
                    '2. Increase practice frequency and improve through scenario drills.',
                    '3. Seek guidance from mentors and continuously improve weak points.',
                    '4. Set improvement goals and track progress regularly.'
                ];
            }

            Object.keys(lostPoints).forEach(category => {
                if (lostPoints[category] >= 5) {
                    suggestions.push(`- Focus on improving ${category}`);
                }
            });

            suggestions.forEach(suggestion => {
                if (yPos > pageHeight - 15) {
                    pdf.addPage();
                    yPos = 20;
                }
                const lines = pdf.splitTextToSize(suggestion, pageWidth - 40);
                lines.forEach(line => {
                    pdf.text(line, 20, yPos);
                    yPos += 6;
                });
            });

            // é¡µè„š
            const footerY = pageHeight - 10;
            pdf.setFontSize(8);
            pdf.setTextColor(127, 140, 141);
            pdf.text(`Report Generated: ${new Date().toLocaleString('zh-CN')}`, pageWidth / 2, footerY, { align: 'center' });

            // ä¿å­˜PDF
            pdf.save(`${record.studentName}_Performance_Report_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.pdf`);
        }

        // å¯¼å‡ºæ‰€æœ‰ä¸ªäººæŠ¥å‘Š
        async function exportAllPersonalReports() {
            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();

            request.onsuccess = async () => {
                let records = request.result;

                // ç»„é•¿æƒé™æ§åˆ¶
                if (currentUser.role === 'leader') {
                    const leaderName = currentUser.username;
                    records = records.filter(r => r.teamLeader === leaderName || r.team.includes(leaderName));
                }

                if (records.length === 0) {
                    alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                    return;
                }

                if (!confirm(`ç¡®å®šè¦å¯¼å‡º ${records.length} ä»½ä¸ªäººæŠ¥å‘Šå—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)) {
                    return;
                }

                for (let i = 0; i < records.length; i++) {
                    await createPersonalPDFReport(records[i]);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // å»¶è¿Ÿ1ç§’é¿å…æµè§ˆå™¨å¡é¡¿
                }

                alert(`âœ… å·²æˆåŠŸå¯¼å‡º ${records.length} ä»½ä¸ªäººæŠ¥å‘Šï¼`);
            };
        }

        // ç”Ÿæˆå…¨å›½ç»´åº¦æŠ¥å‘Š
        async function generateNationalReport() {
            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();

            request.onsuccess = async () => {
                const records = request.result;

                if (records.length === 0) {
                    alert('æš‚æ— æ•°æ®ï¼');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yPos = 20;

                pdf.setFont('helvetica');

                // æ ‡é¢˜
                pdf.setFontSize(22);
                pdf.setTextColor(44, 62, 80);
                pdf.text('National Training Performance Report', pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;

                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Report Date: ${new Date().toLocaleDateString('zh-CN')}`, pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;

                // æ•´ä½“ç»Ÿè®¡
                const totalCount = records.length;
                const totalScore = records.reduce((sum, r) => sum + r.totalScore, 0);
                const avgScore = (totalScore / totalCount).toFixed(1);
                const excellentCount = records.filter(r => r.totalScore >= 90).length;
                const goodCount = records.filter(r => r.totalScore >= 80 && r.totalScore < 90).length;
                const failCount = records.filter(r => r.totalScore < 80).length;
                const excellentRate = ((excellentCount / totalCount) * 100).toFixed(1);
                const passRate = (((excellentCount + goodCount) / totalCount) * 100).toFixed(1);

                pdf.setFontSize(16);
                pdf.setTextColor(52, 152, 219);
                pdf.text('Overall Statistics', 20, yPos);
                yPos += 10;

                pdf.setFontSize(11);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Total Participants: ${totalCount}`, 25, yPos);
                yPos += 7;
                pdf.text(`Average Score: ${avgScore}`, 25, yPos);
                yPos += 7;
                pdf.text(`Excellent (>=90): ${excellentCount} (${excellentRate}%)`, 25, yPos);
                yPos += 7;
                pdf.text(`Good (80-89): ${goodCount} (${((goodCount / totalCount) * 100).toFixed(1)}%)`, 25, yPos);
                yPos += 7;
                pdf.text(`Below Standard (<80): ${failCount} (${((failCount / totalCount) * 100).toFixed(1)}%)`, 25, yPos);
                yPos += 7;
                pdf.text(`Pass Rate (>=80): ${passRate}%`, 25, yPos);
                yPos += 12;

                // å„ç»´åº¦å¹³å‡å¾—åˆ†
                pdf.setFontSize(16);
                pdf.setTextColor(52, 152, 219);
                pdf.text('Average Scores by Dimension', 20, yPos);
                yPos += 10;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);

                Object.keys(scoringCriteria).forEach(key => {
                    const category = scoringCriteria[key];
                    const avgCategoryScore = (records.reduce((sum, r) => sum + (r.scores[category.name] || 0), 0) / totalCount).toFixed(1);
                    const percent = ((avgCategoryScore / category.maxScore) * 100).toFixed(0);
                    pdf.text(`${category.name}: ${avgCategoryScore}/${category.maxScore} (${percent}%)`, 25, yPos);
                    yPos += 6;

                    if (yPos > pageHeight - 20) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });
                yPos += 10;

                // æŒ‰èŒåœºç»Ÿè®¡
                const workplaceStats = {};
                records.forEach(r => {
                    if (!workplaceStats[r.workplace]) {
                        workplaceStats[r.workplace] = [];
                    }
                    workplaceStats[r.workplace].push(r.totalScore);
                });

                if (yPos > pageHeight - 60) {
                    pdf.addPage();
                    yPos = 20;
                }

                pdf.setFontSize(16);
                pdf.setTextColor(52, 152, 219);
                pdf.text('Performance by Workplace', 20, yPos);
                yPos += 10;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);

                Object.entries(workplaceStats).sort((a, b) => {
                    const avgA = a[1].reduce((sum, s) => sum + s, 0) / a[1].length;
                    const avgB = b[1].reduce((sum, s) => sum + s, 0) / b[1].length;
                    return avgB - avgA;
                }).forEach(([workplace, scores]) => {
                    const avg = (scores.reduce((sum, s) => sum + s, 0) / scores.length).toFixed(1);
                    const excellent = scores.filter(s => s >= 90).length;
                    const excellentRate = ((excellent / scores.length) * 100).toFixed(1);
                    pdf.text(`${workplace}: Count=${scores.length}, Avg=${avg}, Excellent Rate=${excellentRate}%`, 25, yPos);
                    yPos += 6;

                    if (yPos > pageHeight - 20) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });

                // é¡µè„š
                const footerY = pageHeight - 10;
                pdf.setFontSize(8);
                pdf.setTextColor(127, 140, 141);
                pdf.text(`Report Generated: ${new Date().toLocaleString('zh-CN')}`, pageWidth / 2, footerY, { align: 'center' });

                pdf.save(`National_Report_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.pdf`);
                alert('âœ… å…¨å›½æŠ¥å‘Šå·²ç”Ÿæˆï¼');
            };
        }

        // ç”ŸæˆèŒåœºç»´åº¦æŠ¥å‘Š
        async function generateWorkplaceReport() {
            const workplace = prompt('è¯·è¾“å…¥è¦ç”ŸæˆæŠ¥å‘Šçš„èŒåœºåç§°ï¼š');
            if (!workplace) return;

            const transaction = db.transaction(['records'], 'readonly');
            const store = transaction.objectStore('records');
            const request = store.getAll();

            request.onsuccess = async () => {
                const allRecords = request.result;
                const records = allRecords.filter(r => r.workplace === workplace);

                if (records.length === 0) {
                    alert(`èŒåœº"${workplace}"æš‚æ— æ•°æ®ï¼`);
                    return;
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yPos = 20;

                pdf.setFont('helvetica');

                // æ ‡é¢˜
                pdf.setFontSize(20);
                pdf.setTextColor(44, 62, 80);
                pdf.text(`Workplace Performance Report`, pageWidth / 2, yPos, { align: 'center' });
                yPos += 10;
                pdf.setFontSize(16);
                pdf.text(`${workplace}`, pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;

                // ç»Ÿè®¡æ•°æ®
                const totalCount = records.length;
                const avgScore = (records.reduce((sum, r) => sum + r.totalScore, 0) / totalCount).toFixed(1);
                const excellentCount = records.filter(r => r.totalScore >= 90).length;
                const goodCount = records.filter(r => r.totalScore >= 80 && r.totalScore < 90).length;
                const failCount = records.filter(r => r.totalScore < 80).length;

                pdf.setFontSize(14);
                pdf.setTextColor(52, 152, 219);
                pdf.text('Overall Statistics', 20, yPos);
                yPos += 10;

                pdf.setFontSize(11);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Total Participants: ${totalCount}`, 25, yPos);
                yPos += 7;
                pdf.text(`Average Score: ${avgScore}`, 25, yPos);
                yPos += 7;
                pdf.text(`Excellent (>=90): ${excellentCount} (${((excellentCount / totalCount) * 100).toFixed(1)}%)`, 25, yPos);
                yPos += 7;
                pdf.text(`Good (80-89): ${goodCount} (${((goodCount / totalCount) * 100).toFixed(1)}%)`, 25, yPos);
                yPos += 7;
                pdf.text(`Below Standard (<80): ${failCount} (${((failCount / totalCount) * 100).toFixed(1)}%)`, 25, yPos);
                yPos += 12;

                // å„ç»´åº¦å¹³å‡åˆ†
                pdf.setFontSize(14);
                pdf.setTextColor(52, 152, 219);
                pdf.text('Average Scores by Dimension', 20, yPos);
                yPos += 10;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);

                Object.keys(scoringCriteria).forEach(key => {
                    const category = scoringCriteria[key];
                    const avgCategoryScore = (records.reduce((sum, r) => sum + (r.scores[category.name] || 0), 0) / totalCount).toFixed(1);
                    const percent = ((avgCategoryScore / category.maxScore) * 100).toFixed(0);
                    pdf.text(`${category.name}: ${avgCategoryScore}/${category.maxScore} (${percent}%)`, 25, yPos);
                    yPos += 6;

                    if (yPos > pageHeight - 20) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });
                yPos += 10;

                // æŒ‰å°ç»„ç»Ÿè®¡
                const teamStats = {};
                records.forEach(r => {
                    if (!teamStats[r.team]) {
                        teamStats[r.team] = [];
                    }
                    teamStats[r.team].push(r.totalScore);
                });

                if (yPos > pageHeight - 60) {
                    pdf.addPage();
                    yPos = 20;
                }

                pdf.setFontSize(14);
                pdf.setTextColor(52, 152, 219);
                pdf.text('Performance by Team', 20, yPos);
                yPos += 10;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);

                Object.entries(teamStats).sort((a, b) => {
                    const avgA = a[1].reduce((sum, s) => sum + s, 0) / a[1].length;
                    const avgB = b[1].reduce((sum, s) => sum + s, 0) / b[1].length;
                    return avgB - avgA;
                }).forEach(([team, scores]) => {
                    const avg = (scores.reduce((sum, s) => sum + s, 0) / scores.length).toFixed(1);
                    const excellent = scores.filter(s => s >= 90).length;
                    pdf.text(`${team}: Count=${scores.length}, Avg=${avg}, Excellent=${excellent}`, 25, yPos);
                    yPos += 6;

                    if (yPos > pageHeight - 20) {
                        pdf.addPage();
                        yPos = 20;
                    }
                });

                // é¡µè„š
                const footerY = pageHeight - 10;
                pdf.setFontSize(8);
                pdf.setTextColor(127, 140, 141);
                pdf.text(`Report Generated: ${new Date().toLocaleString('zh-CN')}`, pageWidth / 2, footerY, { align: 'center' });

                pdf.save(`${workplace}_Report_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.pdf`);
                alert(`âœ… èŒåœº"${workplace}"æŠ¥å‘Šå·²ç”Ÿæˆï¼`);
            };
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>